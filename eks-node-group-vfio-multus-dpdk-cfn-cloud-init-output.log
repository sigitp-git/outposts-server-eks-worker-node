### CFN Template: https://github.com/sigitp-git/outposts-server-eks-worker-node/blob/main/eks-node-group-vfio-multus-dpdk-cfn.yaml 

[root@ip-172-31-42-93 ~]# cat /var/log/cloud-init-output.log
Cloud-init v. 22.2.2 running 'init' at Wed, 07 Aug 2024 19:25:40 +0000. Up 48.36 seconds.
ci-info: ++++++++++++++++++++++++++++++++++++++Net device info+++++++++++++++++++++++++++++++++++++++
ci-info: +--------+------+-----------------------------+---------------+--------+-------------------+
ci-info: | Device |  Up  |           Address           |      Mask     | Scope  |     Hw-Address    |
ci-info: +--------+------+-----------------------------+---------------+--------+-------------------+
ci-info: |  ens5  | True |         172.31.42.93        | 255.255.240.0 | global | 0e:e6:1c:76:32:71 |
ci-info: |  ens5  | True | fe80::ce6:1cff:fe76:3271/64 |       .       |  link  | 0e:e6:1c:76:32:71 |
ci-info: |   lo   | True |          127.0.0.1          |   255.0.0.0   |  host  |         .         |
ci-info: |   lo   | True |           ::1/128           |       .       |  host  |         .         |
ci-info: +--------+------+-----------------------------+---------------+--------+-------------------+
ci-info: ++++++++++++++++++++++++++++++Route IPv4 info++++++++++++++++++++++++++++++
ci-info: +-------+-------------+-------------+-----------------+-----------+-------+
ci-info: | Route | Destination |   Gateway   |     Genmask     | Interface | Flags |
ci-info: +-------+-------------+-------------+-----------------+-----------+-------+
ci-info: |   0   |   0.0.0.0   | 172.31.32.1 |     0.0.0.0     |    ens5   |   UG  |
ci-info: |   1   |  172.31.0.2 | 172.31.32.1 | 255.255.255.255 |    ens5   |  UGH  |
ci-info: |   2   | 172.31.32.0 |   0.0.0.0   |  255.255.240.0  |    ens5   |   U   |
ci-info: |   3   | 172.31.32.1 |   0.0.0.0   | 255.255.255.255 |    ens5   |   UH  |
ci-info: +-------+-------------+-------------+-----------------+-----------+-------+
ci-info: +++++++++++++++++++Route IPv6 info+++++++++++++++++++
ci-info: +-------+-------------+---------+-----------+-------+
ci-info: | Route | Destination | Gateway | Interface | Flags |
ci-info: +-------+-------------+---------+-----------+-------+
ci-info: |   0   |  fe80::/64  |    ::   |    ens5   |   U   |
ci-info: |   2   |    local    |    ::   |    ens5   |   U   |
ci-info: |   3   |  multicast  |    ::   |    ens5   |   U   |
ci-info: +-------+-------------+---------+-----------+-------+
2024-08-07 19:25:42,813 - __init__.py[WARNING]: Unhandled unknown content-type (application/node.eks.aws) userdata: 'b'---'...'
Generating public/private ed25519 key pair.
Your identification has been saved in /etc/ssh/ssh_host_ed25519_key
Your public key has been saved in /etc/ssh/ssh_host_ed25519_key.pub
The key fingerprint is:
SHA256:wMXHDcyQmVYYfzcrzfI/uSe4PxWwvJ8E9Vynjf9bc78 root@ip-172-31-42-93.ec2.internal
The key's randomart image is:
+--[ED25519 256]--+
|       .+%oo     |
|     . .B.= .. .o|
|      o. .. o *=+|
|       .   . Bo++|
|        S   o *..|
|             = .o|
|             .+o*|
|            . o*B|
|            .o.EO|
+----[SHA256]-----+
Generating public/private ecdsa key pair.
Your identification has been saved in /etc/ssh/ssh_host_ecdsa_key
Your public key has been saved in /etc/ssh/ssh_host_ecdsa_key.pub
The key fingerprint is:
SHA256:IzPWC5ppLMDPtUWm3+xN8pZteMIlRKgq+eE51S3r7kI root@ip-172-31-42-93.ec2.internal
The key's randomart image is:
+---[ECDSA 256]---+
|          .      |
|         . .     |
|       o. .      |
|.     +o   .     |
|..  .oB.S o      |
| .o+.B+Eo= o .   |
|  .oX.=..++.*    |
|   o = ...=* +   |
|      . ==.o+    |
+----[SHA256]-----+
Cloud-init v. 22.2.2 running 'modules:config' at Wed, 07 Aug 2024 19:25:44 +0000. Up 52.52 seconds.
Cloud-init v. 22.2.2 running 'modules:final' at Wed, 07 Aug 2024 19:25:45 +0000. Up 53.02 seconds.
+ subnetids='subnet-07e307dd87d2fda6d subnet-0e7ea408f5498edca subnet-06bdb51568507bb84'
+ secgrpids=sg-0d504267a1a2f84f3
+ pciIdtoBind=0000:00:07.0
+ IFS=' '
+ read -ra subnetList
+ IFS=' '
+ read -ra secGrpList
+ subnetListLen=3
+ secGrpListLen=1
+ '[' 3 '!=' 1 ']'
+ x=0
+ for subnet in "${subnetList[@]}"
+ secGrpList[${x}]=sg-0d504267a1a2f84f3
+ x=1
+ for subnet in "${subnetList[@]}"
+ secGrpList[${x}]=sg-0d504267a1a2f84f3
+ x=2
+ for subnet in "${subnetList[@]}"
+ secGrpList[${x}]=sg-0d504267a1a2f84f3
+ x=3
+ n=0
+ for subnetId in "${subnetList[@]}"
+ secGrpId=sg-0d504267a1a2f84f3
++ aws ec2 describe-subnets --subnet-ids subnet-07e307dd87d2fda6d --query 'Subnets[*].Ipv6CidrBlockAssociationSet[*].Ipv6CidrBlock' --output text
+ subnetipv6=
+ '[' -n '' ']'
++ jq -r .NetworkInterface.NetworkInterfaceId
++ aws ec2 create-network-interface --subnet-id subnet-07e307dd87d2fda6d --description VRF1 --groups sg-0d504267a1a2f84f3 --tag-specifications 'ResourceType=network-interface,        Tags=[{Key=node.k8s.amazonaws.com/no_manage,Value=true}]'
+ multusId=eni-01324c3d44a970c4c
++ curl -s -X PUT http://169.254.169.254/latest/api/token -H 'X-aws-ec2-metadata-token-ttl-seconds: 21600'
+ TOKEN=AQAEADdgOT6RflsyRsJqSYNzEfHdlDgJ-wOe0nWHCeeuI-_4mb2lLQ==
++ jq -r .AttachmentId
+++ curl -s -H 'X-aws-ec2-metadata-token: AQAEADdgOT6RflsyRsJqSYNzEfHdlDgJ-wOe0nWHCeeuI-_4mb2lLQ==' http://169.254.169.254/latest/meta-data/instance-id
++ aws ec2 attach-network-interface --network-interface-id eni-01324c3d44a970c4c --instance-id i-0e3b9338098e68013 --device-index 1

An error occurred (InvalidParameterCombination) when calling the AttachNetworkInterface operation: You may not attach a network interface to an instance if they are not in the same availability zone
+ attachmentId=
+ aws ec2 modify-network-interface-attribute --network-interface-id eni-01324c3d44a970c4c --no-source-dest-check
+ aws ec2 modify-network-interface-attribute --attachment AttachmentId=,DeleteOnTermination=True --network-interface-id eni-01324c3d44a970c4c

An error occurred (MissingParameter) when calling the ModifyNetworkInterfaceAttribute operation: The request must contain the parameter attachment deleteOnTermination
+ n=1
+ for subnetId in "${subnetList[@]}"
+ secGrpId=sg-0d504267a1a2f84f3
++ aws ec2 describe-subnets --subnet-ids subnet-0e7ea408f5498edca --query 'Subnets[*].Ipv6CidrBlockAssociationSet[*].Ipv6CidrBlock' --output text
+ subnetipv6=
+ '[' -n '' ']'
++ aws ec2 create-network-interface --subnet-id subnet-0e7ea408f5498edca --description VRF2 --groups sg-0d504267a1a2f84f3 --tag-specifications 'ResourceType=network-interface,        Tags=[{Key=node.k8s.amazonaws.com/no_manage,Value=true}]'
++ jq -r .NetworkInterface.NetworkInterfaceId
+ multusId=eni-089f1f5069c6e20e0
++ curl -s -X PUT http://169.254.169.254/latest/api/token -H 'X-aws-ec2-metadata-token-ttl-seconds: 21600'
+ TOKEN=AQAEADdgOT583heuVPmL152yk8HgKl6zjeuLLvXOwXbStM1F1p-OhQ==
++ jq -r .AttachmentId
+++ curl -s -H 'X-aws-ec2-metadata-token: AQAEADdgOT583heuVPmL152yk8HgKl6zjeuLLvXOwXbStM1F1p-OhQ==' http://169.254.169.254/latest/meta-data/instance-id
++ aws ec2 attach-network-interface --network-interface-id eni-089f1f5069c6e20e0 --instance-id i-0e3b9338098e68013 --device-index 2
+ attachmentId=eni-attach-0701de8d1d763ee5d
+ aws ec2 modify-network-interface-attribute --network-interface-id eni-089f1f5069c6e20e0 --no-source-dest-check
+ aws ec2 modify-network-interface-attribute --attachment AttachmentId=eni-attach-0701de8d1d763ee5d,DeleteOnTermination=True --network-interface-id eni-089f1f5069c6e20e0
+ n=2
+ for subnetId in "${subnetList[@]}"
+ secGrpId=sg-0d504267a1a2f84f3
++ aws ec2 describe-subnets --subnet-ids subnet-06bdb51568507bb84 --query 'Subnets[*].Ipv6CidrBlockAssociationSet[*].Ipv6CidrBlock' --output text
+ subnetipv6=
+ '[' -n '' ']'
++ aws ec2 create-network-interface --subnet-id subnet-06bdb51568507bb84 --description VRF3 --groups sg-0d504267a1a2f84f3 --tag-specifications 'ResourceType=network-interface,        Tags=[{Key=node.k8s.amazonaws.com/no_manage,Value=true}]'
++ jq -r .NetworkInterface.NetworkInterfaceId
+ multusId=eni-0417d343ecca31180
++ curl -s -X PUT http://169.254.169.254/latest/api/token -H 'X-aws-ec2-metadata-token-ttl-seconds: 21600'
+ TOKEN=AQAEADdgOT7hiRadpjQyyW9Qn98UOxEFJ9DgH0diplUKQhcwCiLCPw==
++ jq -r .AttachmentId
+++ curl -s -H 'X-aws-ec2-metadata-token: AQAEADdgOT7hiRadpjQyyW9Qn98UOxEFJ9DgH0diplUKQhcwCiLCPw==' http://169.254.169.254/latest/meta-data/instance-id
++ aws ec2 attach-network-interface --network-interface-id eni-0417d343ecca31180 --instance-id i-0e3b9338098e68013 --device-index 3

An error occurred (InvalidParameterCombination) when calling the AttachNetworkInterface operation: You may not attach a network interface to an instance if they are not in the same availability zone
+ attachmentId=
+ aws ec2 modify-network-interface-attribute --network-interface-id eni-0417d343ecca31180 --no-source-dest-check
+ aws ec2 modify-network-interface-attribute --attachment AttachmentId=,DeleteOnTermination=True --network-interface-id eni-0417d343ecca31180

An error occurred (MissingParameter) when calling the ModifyNetworkInterfaceAttribute operation: The request must contain the parameter attachment deleteOnTermination
+ n=3
+ echo '#!/usr/bin/env bash'
+ ls /sys/class/net/
+ cat /tmp/ethList
+ read line
+ sudo ifconfig ens5 up
+ read line
+ sudo ifconfig ens7 up
+ read line
+ sudo ifconfig lo up
+ read line
+ grep ens /tmp/ethList
+ read line
+ echo 'ifconfig ens5 up'
+ read line
+ echo 'ifconfig ens7 up'
+ read line
+ modprobe sctp
+ modprobe vfio-pci
+ echo 1
+ echo 'modprobe sctp'
+ echo 'modprobe vfio-pci'
+ echo 'echo 1 > /sys/module/vfio/parameters/enable_unsafe_noiommu_mode'
+ chmod +x /etc/pm/power.d/node-init-script.sh
+ cat
+ systemctl enable node-init-script.service
Created symlink /etc/systemd/system/network-online.target.wants/node-init-script.service â†’ /etc/systemd/system/node-init-script.service.
+ '[' -f /etc/custom-ami-scripts/runtime-userdata-script.sh ']'
+ /etc/custom-ami-scripts/runtime-userdata-script.sh
/var/lib/cloud/instance/scripts/part-002: line 78: /etc/custom-ami-scripts/runtime-userdata-script.sh: Permission denied
+ '[' 0000:00:07.0 '!=' 0000:00:00.0 ']'
+ '[' -f /etc/custom-ami-scripts/dpdk-devbind.py ']'
++ cut '-d ' -f1
++ cut -d= -f2
++ grep 0000:00:07.0
++ /etc/custom-ami-scripts/dpdk-devbind.py -s
/var/lib/cloud/instance/scripts/part-002: line 84: /etc/custom-ami-scripts/dpdk-devbind.py: Permission denied
+ eth=
+ ifconfig down
down: error fetching interface information: Device not found
+ /etc/custom-ami-scripts/dpdk-devbind.py -u 0000:00:07.0
/var/lib/cloud/instance/scripts/part-002: line 86: /etc/custom-ami-scripts/dpdk-devbind.py: Permission denied
+ /etc/custom-ami-scripts/dpdk-devbind.py -b vfio-pci 0000:00:07.0
/var/lib/cloud/instance/scripts/part-002: line 87: /etc/custom-ami-scripts/dpdk-devbind.py: Permission denied
+ echo 'ifconfig  down'
+ echo '/etc/custom-ami-scripts/dpdk-devbind.py -u 0000:00:07.0'
+ echo '/etc/custom-ami-scripts/dpdk-devbind.py -b vfio-pci 0000:00:07.0'
++ grep -c hugepages /etc/default/grub
+ '[' 1 -ge 1 ']'
++ grep -c hugepages /proc/cmdline
+ '[' 1 -eq 0 ']'
+ echo 'Hugepages already active. No reboot required'
Hugepages already active. No reboot required
Cloud-init v. 22.2.2 finished at Wed, 07 Aug 2024 19:26:10 +0000. Datasource DataSourceEc2.  Up 78.41 seconds
[root@ip-172-31-42-93 ~]#
